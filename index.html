<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KINTORE LOG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-red: #c62828;
    --primary-dark: #b71c1c;
    --bg-color: #c62828;
    --card-bg: #1e1e1e;
    --text-color: #ffffff;
    --input-bg: #2c2c2c;
  }

  body {
    font-family: 'Roboto Condensed', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
  }

  /* VIEW SWITCHING */
  .view-section { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
  .view-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* DASHBOARD */
  header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; }
  .app-title { font-size: 1.2rem; font-weight: bold; letter-spacing: 1px; }
  .settings-icon { font-size: 1.5rem; cursor: pointer; }

  .calendar-wrapper { margin-bottom: 20px; }
  .month-label { font-size: 2.5rem; font-weight: bold; line-height: 1; margin-bottom: 10px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
  .weekday { font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-bottom: 5px; }
  .day-cell { height: 35px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; position: relative; cursor: pointer; }
  .day-cell.today { font-weight: bold; text-decoration: underline; }
  .day-cell.active { background-color: #fff; color: var(--primary-red); border-radius: 50%; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  .stats-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
  .stat-card { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
  .stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.8); display: block; margin-bottom: 5px;}
  .stat-value { font-size: 1.8rem; font-weight: bold; }
  .stat-icon { font-size: 1.5rem; opacity: 0.8; }

  .dash-footer { display: flex; gap: 10px; margin-top: 10px; }
  .big-btn { background-color: #fff; color: var(--primary-red); border: none; padding: 15px; border-radius: 12px; font-size: 1rem; font-weight: bold; flex: 2; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 10px; }
  .big-btn:active { transform: scale(0.98); }

  /* INPUT FORM */
  #input-view { background-color: #121212; min-height: 100vh; }
  .form-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .back-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
  .section-label { font-size: 0.9rem; color: var(--primary-red); font-weight: bold; margin-top: 25px; margin-bottom: 10px; border-left: 3px solid var(--primary-red); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
  .card { background-color: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 8px; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .main-event-wrapper { background-color: var(--card-bg); border-radius: 12px; padding: 12px; margin-bottom: 12px; }
  
  input, select { background-color: var(--input-bg); border: 1px solid #333; color: #fff; border-radius: 6px; padding: 8px; font-size: 1rem; width: 100%; text-align: center; -webkit-appearance: none; }
  input:focus, select:focus { outline: none; border-color: var(--primary-red); }
  
  .warmup-name-input {
    background: transparent !important; border: none !important; color: #aaa !important; 
    font-size: 0.75rem !important; text-align: left !important; padding: 0 !important; width: 100% !important; margin-bottom: 4px;
  }
  .warmup-name-input:focus { color: #fff !important; border-bottom: 1px solid #555 !important; border-radius: 0 !important; }

  .set-row { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
  .set-label { width: 20px; text-align: center; font-size: 0.8rem; color: #888; }
  .rpe-input { width: 45px !important; color: #ffd700 !important; }
  
  .fail-btn { display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; font-size: 1.2rem; color: #444; cursor: pointer; user-select: none; transition: all 0.2s ease; }
  .fail-btn:active { transform: scale(0.9); }
  .fail-btn.active { color: #ff453a; text-shadow: 0 0 8px rgba(255, 69, 58, 0.6); }

  .add-set-btn { background: #333; color: #aaa; border: 1px dashed #555; width: 100%; padding: 8px; border-radius: 6px; margin-top: 5px; }
  
  .prev-info { font-size: 0.75rem; color: #888; text-align: right; margin-bottom: 5px; min-height: 1em; }
  .prev-info span { color: #ffd700; font-weight: bold; }

  .aux-row { background-color: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 8px; }
  .aux-inputs { display: flex; gap: 8px; align-items: center; margin-top: 5px; }

  #generate-btn { background: linear-gradient(135deg, #c62828, #b71c1c); color: white; border: none; padding: 16px; font-size: 1.1rem; font-weight: bold; border-radius: 30px; width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-top: 20px; }
  
  /* Modal */
  #detail-modal, #settings-modal, #result-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: #222; padding: 20px; border-radius: 15px; width: 85%; max-height: 80vh; overflow-y: auto; color: #fff; }
  .modal-close { margin-top: 15px; background: #444; border: none; color: #fff; padding: 10px 20px; border-radius: 20px; width: 100%; }
  
  #gas-url-input { text-align: left; margin-bottom: 10px; font-size: 0.8rem; }
  #result-img { max-width: 100%; border-radius: 8px; }
  
  .chart-container { margin-top: 10px; background-color: var(--card-bg); padding: 15px; border-radius: var(--border-radius); position: relative; }
  #toggle-chart-btn { position: absolute; top: 15px; right: 15px; background: #333; color: #fff; border: 1px solid #555; padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; cursor: pointer; z-index: 10; }
  canvas { display: none; }
</style>
</head>
<body>

<div id="dashboard-view" class="view-section active">
  <header>
    <div class="settings-icon" onclick="openSettings()">‚öôÔ∏è</div>
    <div class="app-title">Á≠ã„Éà„É¨ MEMO</div>
    <div style="width: 24px;"></div>
  </header>

  <div class="calendar-wrapper">
    <div class="month-label" id="cal-month-label"></div>
    <div class="calendar-grid">
      <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div><div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div><span class="stat-label">ÂêàË®àË≤†Ëç∑Èáè / 7Êó•Èñì</span><div class="stat-value" id="stat-7days">0.0 t</div></div>
      <div class="stat-icon">üöó</div>
    </div>
    <div class="stat-card">
      <div><span class="stat-label">ÂêàË®àË≤†Ëç∑Èáè / 28Êó•Èñì</span><div class="stat-value" id="stat-28days">0.0 t</div></div>
      <div class="stat-icon">üöå</div>
    </div>
    <div class="stat-card">
      <div><span class="stat-label">Á∑èÂêàË®àË≤†Ëç∑Èáè</span><div class="stat-value" id="stat-total">0.0 t</div></div>
      <div class="stat-icon">‚úàÔ∏è</div>
    </div>
  </div>

  <div class="dash-footer">
    <button class="big-btn" onclick="switchView('input')"><span>‚äï Êú¨Êó•„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíËøΩÂä†</span></button>
  </div>
</div>

<div id="input-view" class="view-section">
  <div class="form-header">
    <button class="back-btn" onclick="switchView('dashboard')">‚úï</button>
    <span>NEW LOG</span>
    <div style="width: 24px;"></div>
  </div>

  <div style="text-align: center; margin-bottom: 20px;">
    <select id="focus-select" style="width: auto; border-radius: 20px; border: 1px solid var(--primary-red); background: transparent; font-weight: bold; color: var(--primary-red);">
      <option value="STRENGTH">FOCUS: STRENGTH</option>
      <option value="HYPERTROPHY">FOCUS: HYPERTROPHY</option>
      <option value="TECHNIQUE">FOCUS: TECHNIQUE</option>
      <option value="SPEED">FOCUS: SPEED</option>
      <option value="DELOAD">FOCUS: DELOAD</option>
    </select>
  </div>

  <div class="section-label">Step 1: „Ç¢„ÉÉ„Éó (Warm-up)</div>
  <div class="grid" id="warmup-container">
    </div>

  <div class="section-label">Step 2: „É°„Ç§„É≥Á®ÆÁõÆ (BIG 3)</div>
  
  <div class="main-event-wrapper">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
      <select id="main1-type" style="width:60%; text-align:left;" onchange="updatePrevInfo(1)">
        <option value="BENCH PRESS" selected>BENCH PRESS</option>
        <option value="SQUAT">SQUAT</option>
        <option value="DEADLIFT">DEADLIFT</option>
      </select>
      <div id="prev-info-1" class="prev-info"></div>
    </div>
    <div id="sets-container-1" class="sets-container"></div>
    <button class="add-set-btn" onclick="addSet('sets-container-1')">+ „Çª„ÉÉ„Éà„ÇíËøΩÂä†</button>
  </div>

  <div class="main-event-wrapper">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
      <select id="main2-type" style="width:60%; text-align:left;" onchange="updatePrevInfo(2)">
        <option value="NONE">-- 2Á®ÆÁõÆ„ÇÅ („Å™„Åó) --</option>
        <option value="SQUAT" selected>SQUAT</option>
        <option value="BENCH PRESS">BENCH PRESS</option>
        <option value="DEADLIFT">DEADLIFT</option>
      </select>
      <div id="prev-info-2" class="prev-info"></div>
    </div>
    <div id="sets-container-2" class="sets-container"></div>
    <button class="add-set-btn" onclick="addSet('sets-container-2')">+ „Çª„ÉÉ„Éà„ÇíËøΩÂä†</button>
  </div>

  <div class="section-label">Step 3: Ë£úÂä©„Éà„É¨</div>
  <div id="aux-container">
    <script>
      const auxOps=`<option value="NONE">-- Select --</option><option value="Leg Press">Leg Press</option><option value="Leg Extension">Leg Extension</option><option value="Leg Curl">Leg Curl</option><option value="Butterfly">Butterfly</option><option value="Seated Row">Seated Row</option><option value="Shoulder Press">Shoulder Press</option><option value="Triceps PD">Triceps PD</option><option value="Arm Curl">Arm Curl</option><option value="Hack Lift">Hack Lift</option>`;
      for(let i=1;i<=4;i++) document.write(`<div class="aux-row"><select id="aux${i}-type" style="text-align:left;">${auxOps}</select><div class="aux-inputs"><input type="number" id="aux${i}-w" placeholder="kg"><span class="unit">kg</span><input type="number" id="aux${i}-r" placeholder="reps"><span class="unit">reps</span></div></div>`);
    </script>
  </div>

  <div class="memo-container">
    <label>Memo</label>
    <input type="text" id="memo-input" placeholder="„Éï„Ç©„Éº„É†„ÅÆÈÅïÂíåÊÑü„Å™„Å©">
  </div>

  <div class="btn-container">
    <button id="generate-btn">LOG & SAVE</button>
    <div id="sync-status" style="margin-top:5px; font-size:0.7rem; color:#888; text-align:center;"></div>
  </div>
</div>

<div id="detail-modal" style="display:none;" onclick="closeModal('detail-modal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="modal-date" style="border-bottom:1px solid #444; padding-bottom:10px;"></h3>
    <div id="modal-body" style="font-size:0.9rem; line-height:1.6;"></div>
    <button class="modal-close" onclick="closeModal('detail-modal')">Èñâ„Åò„Çã</button>
  </div>
</div>

<div id="settings-modal" style="display:none;" onclick="closeModal('settings-modal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Ë®≠ÂÆö</h3>
    <label style="font-size:0.8rem; color:#aaa;">GAS URL</label>
    <input type="text" id="gas-url-input" placeholder="https://script.google.com/...">
    <button style="margin-top:20px; background:#c62828; color:#fff; border:none; padding:10px; width:100%; border-radius:8px;" onclick="exportData()">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó (JSON Export)</button>
    <button class="modal-close" onclick="closeModal('settings-modal')">Èñâ„Åò„Çã</button>
  </div>
</div>

<div id="result-modal" style="display:none; flex-direction:column;">
  <img id="result-img" src="" alt="Result">
  <div class="modal-text">‚Üì ÁîªÂÉè„ÇíÈï∑Êäº„Åó„Åó„Å¶‰øùÂ≠ò ‚Üì</div>
  <button class="close-btn" onclick="document.getElementById('result-modal').style.display='none'">Èñâ„Åò„Çã</button>
</div>

<div class="section-label">Analytics</div>
<div class="chart-container">
  <button id="toggle-chart-btn" onclick="toggleChartMode()">üîÑ Show MaxWeight</button>
  <canvas id="growthChartCanvas" style="display: block; width:100%; height:250px;"></canvas>
</div>

<canvas id="logCanvas"></canvas>

<script>
  // ==========================================
  // CONFIGURATIONS (Readable Constants)
  // ==========================================
  
  // Volume Calculation Rules
  const VOLUME_RULE = {
    warmupReps: 10,        // Warmup reps constant for volume calc
    includeWarmup: true    // Whether to include warmup volume in total
  };

  const STORAGE_KEY_CURRENT = 'kintore_v7_current';
  const STORAGE_KEY_HISTORY = 'kintore_v7_history';
  const STORAGE_KEY_CONFIG  = 'kintore_v7_config';
  const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbyOJvgxN7KjRdD1JQR6shRDyt0Cl_GpMFBjdcmZoc-j4LbgI6MNHA1aZ8SMI9JSCfTC/exec";

  const getTodayISO = () => new Date().toISOString().slice(0, 10);
  let growthChart = null;
  let chartMode = 'volume';

  const defaultWarmups = [
    {n:"Seated Row", w:40}, {n:"Shoulder Press", w:30}, {n:"Butterfly", w:25}, {n:"Triceps PD", w:30},
    {n:"Arm Curl", w:30}, {n:"Leg Ext", w:50}, {n:"Leg Curl", w:35}, {n:"Hack Lift", w:40}
  ];

  window.onload = function() {
    let config = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) || {};
    if (!config.gasUrl) { config.gasUrl = DEFAULT_GAS_URL; localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config)); }
    document.getElementById('gas-url-input').value = config.gasUrl;
    
    loadFromLocal();
    
    renderCalendar();
    renderStats();
    updatePrevInfo(1);
    updatePrevInfo(2);
    renderChart();
  };

  // ==========================================
  // LOGIC: STRUCTURED DATA
  // ==========================================
  
  function getSetsStructured(id) {
    const rows = document.querySelectorAll(`#${id} .set-row`);
    const sets = [];
    rows.forEach(r => {
        sets.push({
            w: r.querySelector('.mw').value,
            r: r.querySelector('.mr').value,
            rpe: r.querySelector('.rpe-input').value,
            fail: r.querySelector('.fail-btn').classList.contains('active')
        });
    });
    return sets;
  }

  function getWarmupData() {
    const arr = [];
    for(let i=1; i<=8; i++) {
        arr.push({
            n: document.getElementById(`w${i}-name`).value,
            w: document.getElementById(`w${i}`).value
        });
    }
    return arr;
  }

  function saveToLocal() {
    const current = {
        focus: document.getElementById('focus-select').value,
        warmup: getWarmupData(),
        main1: { type: document.getElementById('main1-type').value, sets: getSetsStructured('sets-container-1') },
        main2: { type: document.getElementById('main2-type').value, sets: getSetsStructured('sets-container-2') },
        aux: [],
        memo: document.getElementById('memo-input').value
    };
    for(let i=1; i<=4; i++) {
        current.aux.push({
            type: document.getElementById(`aux${i}-type`).value,
            w: document.getElementById(`aux${i}-w`).value,
            r: document.getElementById(`aux${i}-r`).value
        });
    }
    localStorage.setItem(STORAGE_KEY_CURRENT, JSON.stringify(current));

    const today = getTodayISO();
    const vol = calculateTotalVolume();
    const maxW = calculateMaxWeight();
    
    let hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    const idx = hist.findIndex(h => h.date === today);
    
    const historyEntry = {
        date: today,
        volume: vol,
        maxWeight: maxW,
        focus: current.focus,
        memo: current.memo,
        main1: current.main1, 
        main2: current.main2, 
        aux: current.aux
    };

    if(idx >= 0) hist[idx] = historyEntry;
    else hist.push(historyEntry);
    
    hist.sort((a,b) => new Date(a.date) - new Date(b.date));
    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(hist));
    renderChart();
  }

  function loadFromLocal() {
    const json = localStorage.getItem(STORAGE_KEY_CURRENT);
    const container = document.getElementById('warmup-container');
    container.innerHTML = ''; 

    if(json) {
        try {
            const d = JSON.parse(json);
            if(d.focus) document.getElementById('focus-select').value = d.focus;
            
            // Restore Warmup
            const wData = d.warmup || defaultWarmups;
            wData.forEach((w, i) => {
                container.innerHTML += `
                  <div class="card">
                    <input type="text" id="w${i+1}-name" value="${w.n}" class="warmup-name-input">
                    <div class="input-group"><input type="number" id="w${i+1}" value="${w.w}"><span class="unit">kg</span></div>
                  </div>`;
            });

            if(d.main1) {
                document.getElementById('main1-type').value = d.main1.type;
                restoreSets('sets-container-1', d.main1.sets);
            }
            if(d.main2) {
                document.getElementById('main2-type').value = d.main2.type;
                restoreSets('sets-container-2', d.main2.sets);
            }
            
            if(d.aux) {
                d.aux.forEach((a, i) => {
                    if(i < 4) {
                        const idx = i+1;
                        document.getElementById(`aux${idx}-type`).value = a.type;
                        document.getElementById(`aux${idx}-w`).value = a.w;
                        document.getElementById(`aux${idx}-r`).value = a.r;
                    }
                });
            }
            if(d.memo) document.getElementById('memo-input').value = d.memo;
            return true;
        } catch(e) { console.error(e); }
    }

    // Fallback
    defaultWarmups.forEach((w, i) => {
        container.innerHTML += `
          <div class="card">
            <input type="text" id="w${i+1}-name" value="${w.n}" class="warmup-name-input">
            <div class="input-group"><input type="number" id="w${i+1}" value="${w.w}"><span class="unit">kg</span></div>
          </div>`;
    });
    addSet('sets-container-1', 100, 5); addSet('sets-container-1'); addSet('sets-container-1');
    addSet('sets-container-2'); addSet('sets-container-2'); addSet('sets-container-2');
    return false;
  }

  function restoreSets(id, sets) {
    const c = document.getElementById(id); c.innerHTML='';
    if(sets && sets.length) sets.forEach(s=>addSet(id, s.w, s.r, s.rpe, s.fail));
    else addSet(id);
  }

  // ==========================================
  // CALCULATIONS (Using VOLUME_RULE)
  // ==========================================
  function calculateTotalVolume() {
    let vol = 0;

    // 1. Warm-up
    if (VOLUME_RULE.includeWarmup) {
      // Warmups are dynamically generated in the grid
      // We need to query all wX inputs
      for(let i=1; i<=8; i++) {
         // Check if element exists to be safe
         const el = document.getElementById(`w${i}`);
         if(el) {
             vol += (parseFloat(el.value)||0) * VOLUME_RULE.warmupReps;
         }
      }
    }

    // 2. Main
    ['sets-container-1','sets-container-2'].forEach(id=>{
      document.querySelectorAll(`#${id} .set-row`).forEach(row=>{
        vol += (parseFloat(row.querySelector('.mw').value)||0)*(parseFloat(row.querySelector('.mr').value)||0);
      });
    });

    // 3. Aux
    for(let i=1; i<=4; i++) {
        const wEl = document.getElementById(`aux${i}-w`);
        const rEl = document.getElementById(`aux${i}-r`);
        if(wEl && rEl) {
            vol += (parseFloat(wEl.value)||0)*(parseFloat(rEl.value)||0);
        }
    }
    
    return Math.round(vol);
  }

  function calculateMaxWeight() {
    let maxW = 0;
    ['sets-container-1','sets-container-2'].forEach(id=>{
      document.querySelectorAll(`#${id} .set-row`).forEach(row=>{ const w = parseFloat(row.querySelector('.mw').value)||0; if(w>maxW) maxW=w; });
    });
    return maxW;
  }

  // ==========================================
  // ANALYTICS & PREV INFO
  // ==========================================
  function updatePrevInfo(slotId) {
    const type = document.getElementById(`main${slotId}-type`).value;
    const div = document.getElementById(`prev-info-${slotId}`);
    if(type === 'NONE') { div.innerHTML=''; return; }

    const hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    let maxW = 0;

    for(let i = hist.length - 1; i >= 0; i--) {
      const h = hist[i];
      if(h.main1) {
          if (typeof h.main1 === 'string' && h.main1.includes(type)) { // Old format support
              const m = extractMaxWeightString(h.main1); if(m>maxW) maxW=m; break;
          } else if (h.main1.type === type && h.main1.sets) { // New Object format
              const m = extractMaxWeightObj(h.main1.sets); if(m>maxW) maxW=m; break;
          }
      }
      if(h.main2) {
          if (typeof h.main2 === 'string' && h.main2.includes(type)) {
              const m = extractMaxWeightString(h.main2); if(m>maxW) maxW=m; break;
          } else if (h.main2.type === type && h.main2.sets) {
              const m = extractMaxWeightObj(h.main2.sets); if(m>maxW) maxW=m; break;
          }
      }
    }
    div.innerHTML = maxW > 0 ? `Prev Max: <span>${maxW}kg</span>` : `New Record`;
  }

  function extractMaxWeightObj(sets) {
      let max = 0;
      sets.forEach(s => { const w = parseFloat(s.w)||0; if(w>max) max=w; });
      return max;
  }
  function extractMaxWeightString(str) {
      const matches = str.match(/(\d+(\.\d+)?)kg/g);
      if(!matches) return 0;
      let max = 0;
      matches.forEach(m => { const w = parseFloat(m.replace('kg','')); if(w>max) max=w; });
      return max;
  }

  // ==========================================
  // SYNC
  // ==========================================
  function formatSetsString(sets) {
      return sets.map(s => {
          if(!s.w || !s.r) return null;
          let str = `${s.w}kg x ${s.r}`;
          if(s.rpe) str += ` (@${s.rpe})`;
          if(s.fail) str += ` (F)`;
          return str;
      }).filter(Boolean).join(', ');
  }

  async function sendToSheets(volume, maxWeight) {
    const config = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) || {};
    if (!config.gasUrl) return;

    const btn = document.getElementById('generate-btn');
    const statusDiv = document.getElementById('sync-status');
    btn.innerText = "Syncing..."; btn.classList.add('sending');

    const m1Data = { type: document.getElementById('main1-type').value, sets: getSetsStructured('sets-container-1') };
    const m2Data = { type: document.getElementById('main2-type').value, sets: getSetsStructured('sets-container-2') };
    
    const main1Str = `${m1Data.type}: ${formatSetsString(m1Data.sets)}`;
    const main2Str = `${m2Data.type}: ${formatSetsString(m2Data.sets)}`;
    
    let auxText = [];
    for(let i=1; i<=4; i++){ const t = document.getElementById(`aux${i}-type`).value; if(t!=='NONE') auxText.push(t); }

    const payload = {
        date: getTodayISO(), 
        focus: document.getElementById('focus-select').value,
        main1: main1Str,
        main2: main2Str,
        aux: auxText.join(', '), 
        memo: document.getElementById('memo-input').value, 
        volume: volume,
        maxWeight: maxWeight
    };

    try {
        await fetch(config.gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        btn.innerText = "Saved & Synced!";
        const d = new Date();
        const syncTime = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        statusDiv.innerText = `ÊúÄÁµÇÂêåÊúü: ${syncTime}`;
        config.lastSync = syncTime;
        localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
        setTimeout(() => { btn.innerText = "LOG & SAVE"; btn.classList.remove('sending'); }, 2000);
    } catch (e) { console.error(e); btn.innerText = "Save Error"; setTimeout(() => { btn.innerText = "LOG & SAVE"; btn.classList.remove('sending'); }, 2000); }
  }

  // ==========================================
  // UI HANDLERS
  // ==========================================
  function addSet(containerId, w=null, r=null, rpe=null, fail=false) {
    const c = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'set-row';
    const failClass = fail ? 'active' : '';
    div.innerHTML = `
      <span class="set-label">${c.children.length+1}</span>
      <input type="number" class="mw" placeholder="kg" value="${w!==null?w:''}"><input type="number" class="mr" placeholder="reps" value="${r!==null?r:''}"><input type="number" class="rpe-input" placeholder="RPE" value="${rpe!==null?rpe:''}">
      <div class="fail-btn ${failClass}" onclick="this.classList.toggle('active')">‚ö†Ô∏è</div>
    `;
    c.appendChild(div);
  }

  function switchView(viewName) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(viewName + '-view').classList.add('active');
    if(viewName==='dashboard'){ renderCalendar(); renderStats(); renderChart(); }
    else if(viewName==='input'){ updatePrevInfo(1); updatePrevInfo(2); }
  }
  function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  function toggleChartMode() { chartMode = (chartMode === 'volume') ? 'maxWeight' : 'volume'; document.getElementById('toggle-chart-btn').innerText = (chartMode === 'volume') ? 'üîÑ Show MaxWeight' : 'üîÑ Show Volume'; renderChart(); }

  document.getElementById('gas-url-input').addEventListener('change', (e) => {
    let config = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) || {}; config.gasUrl = e.target.value.trim(); localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
  });

  function exportData() {
    const backup = { current: JSON.parse(localStorage.getItem(STORAGE_KEY_CURRENT)), history: JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)), config: JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) };
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `kintore_backup_${getTodayISO()}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // Generate Button Logic
  document.getElementById('generate-btn').addEventListener('click', () => {
    saveToLocal();
    const volume = calculateTotalVolume();
    const maxWeight = calculateMaxWeight();
    sendToSheets(volume, maxWeight);

    const canvas = document.getElementById('logCanvas');
    const ctx = canvas.getContext('2d');
    
    // Draw Canvas
    const sets1 = getSetsStructured('sets-container-1');
    const sets2 = getSetsStructured('sets-container-2');
    const type1 = document.getElementById('main1-type').value;
    const type2 = document.getElementById('main2-type').value;
    
    let maxSets = 0;
    if(type1!=='NONE') maxSets = Math.max(maxSets, sets1.length);
    if(type2!=='NONE') maxSets = Math.max(maxSets, sets2.length);
    let auxCount=0;
    for(let i=1; i<=4; i++) if(document.getElementById(`aux${i}-type`).value !== 'NONE') auxCount++;
    const memo = document.getElementById('memo-input').value;

    canvas.width = 600;
    let h = 400 + (maxSets?70+maxSets*30+30:0) + (auxCount?50+auxCount*35+20:0) + (memo?50:0) + 40;
    canvas.height = h;

    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,600,h);
    ctx.fillStyle = "#000"; ctx.textAlign="center"; ctx.font="bold 40px Helvetica"; ctx.fillText("SUZUKI DOJO",300,55);
    ctx.fillStyle = "#555"; ctx.font="16px Helvetica";
    const dateDisp = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
    ctx.fillText(`${dateDisp}  |  ${document.getElementById('focus-select').value}  |  VOL: ${volume.toLocaleString()}kg`, 300, 85);
    ctx.beginPath(); ctx.moveTo(40,105); ctx.lineTo(560,105); ctx.strokeStyle="#ddd"; ctx.stroke();

    let y = 145;
    ctx.textAlign="left"; ctx.fillStyle="#000"; ctx.font="bold 22px Helvetica"; ctx.fillText("Step 1: „Ç¢„ÉÉ„Éó",40,y); y+=40;
    const wData = getWarmupData();
    ctx.font="18px Helvetica";
    wData.forEach((w,i)=>{const x=i%2===0?40:320; if(i%2===0&&i!==0)y+=30; ctx.fillStyle="#444"; ctx.textAlign="left"; ctx.fillText(w.n,x,y); ctx.fillStyle="#000"; ctx.textAlign="right"; ctx.fillText(w.w+"kg",x+240,y);});
    y+=50; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(560,y); ctx.stroke(); y+=40;

    if(maxSets>0){
        ctx.textAlign="left"; ctx.fillStyle="#000"; ctx.font="bold 22px Helvetica"; ctx.fillText("Step 2: „É°„Ç§„É≥Á®ÆÁõÆ",40,y); y+=20;
        const hY=y+25; ctx.font="bold 18px Helvetica"; ctx.fillStyle="#cc0000";
        if(type1!=='NONE'){ctx.textAlign="center"; ctx.fillText(type1.split(' ')[0],170,hY);}
        if(type2!=='NONE'){ctx.textAlign="center"; ctx.fillText(type2.split(' ')[0],430,hY);}
        y=hY+15; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(560,y); ctx.strokeStyle="#555"; ctx.stroke(); y+=30;
        ctx.fillStyle="#000"; ctx.font="20px Helvetica";
        for(let i=0; i<maxSets; i++){
            const drawSet = (s, x) => {
                if(!s || (!s.w && !s.r)) return;
                let str = `${s.w}kg √ó ${s.r}`;
                if(s.rpe) str += ` (@${s.rpe})`;
                if(s.fail) { ctx.fillStyle="#cc0000"; str += ` (F)`; } else { ctx.fillStyle="#000"; }
                ctx.textAlign="center"; ctx.fillText(str,x,y);
            };
            if(type1!=='NONE') drawSet(sets1[i], 170);
            if(type2!=='NONE') drawSet(sets2[i], 430);
            y+=30;
        }
        ctx.beginPath(); ctx.moveTo(300,hY-25); ctx.lineTo(300,y-15); ctx.strokeStyle="#ccc"; ctx.stroke();
        y+=10; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(560,y); ctx.strokeStyle="#ddd"; ctx.stroke(); y+=40;
    }

    if(auxCount>0){
        ctx.textAlign="left"; ctx.fillStyle="#000"; ctx.font="bold 22px Helvetica"; ctx.fillText("Step 3: Ë£úÂä©„Éà„É¨",40,y); y+=35;
        for(let i=1; i<=4; i++){
            const t=document.getElementById(`aux${i}-type`).value, w=document.getElementById(`aux${i}-w`).value, r=document.getElementById(`aux${i}-r`).value;
            if(t!=='NONE'){ctx.font="18px Helvetica"; ctx.textAlign="left"; ctx.fillText("„Éª"+t,60,y); if(w&&r){ctx.textAlign="right"; ctx.font="bold 20px Helvetica"; ctx.fillText(`${w}kg √ó ${r}`,560,y);} y+=35;}
        }
        y+=20;
    }
    if(memo){ ctx.textAlign="center"; ctx.font="italic 18px Helvetica"; ctx.fillStyle="#000"; ctx.fillText("Note: "+memo,300,y); }

    document.getElementById('result-img').src = canvas.toDataURL('image/png');
    document.getElementById('result-modal').style.display = 'flex';
  });

  // Render Functions
  function renderCalendar() {
    const today = new Date(); const year = today.getFullYear(); const month = today.getMonth();
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    document.getElementById('cal-month-label').innerText = `${months[month]} ${year}`;
    const container = document.getElementById('calendar-days'); container.innerHTML = '';
    const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
    const hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    const activeDays = new Set(hist.map(h => h.date));
    for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;
    for(let d=1; d<=daysInMonth; d++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const div = document.createElement('div'); div.className = 'day-cell'; div.innerText = d;
      if(activeDays.has(dateStr)) { div.classList.add('active'); div.onclick = () => showDayDetail(dateStr); }
      if(d === today.getDate()) div.classList.add('today');
      container.appendChild(div);
    }
  }

  function showDayDetail(dateStr) {
    const hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    const entry = hist.find(h => h.date === dateStr);
    if(!entry) return;
    document.getElementById('modal-date').innerText = dateStr;
    
    // Handle both String (old) and Object (new) formats for display
    const renderMain = (m) => {
        if(!m) return "";
        if(typeof m === 'string') return m; // Old format
        // New format: Object
        let html = `<strong>${m.type}</strong><br>`;
        m.sets.forEach((s, i) => {
            if(s.w || s.r) html += `Set ${i+1}: ${s.w}kg x ${s.r}${s.rpe?' @'+s.rpe:''}${s.fail?' (Fail)':''}<br>`;
        });
        return html;
    };

    let html = `
      <div style="margin-bottom:10px; color:#aaa;">Focus: <span style="color:#fff;">${entry.focus}</span></div>
      <div style="margin-bottom:15px; font-weight:bold; color:#ff453a;">Vol: ${parseInt(entry.volume).toLocaleString()}kg</div>
      <div style="background:#333; padding:10px; border-radius:8px; margin-bottom:10px;">
        <div style="font-size:0.8rem; color:#888;">Main Event</div>
        <div>${renderMain(entry.main1)}</div>
        <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">${renderMain(entry.main2)}</div>
      </div>
    `;
    if(entry.memo) html += `<div style="font-style:italic; color:#ccc;">"${entry.memo}"</div>`;
    document.getElementById('modal-body').innerHTML = html;
    document.getElementById('detail-modal').style.display = 'flex';
  }

  function renderStats() {
    const hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    const today = new Date(); const oneDay = 24*60*60*1000;
    let vol7=0, vol28=0, volTotal=0;
    hist.forEach(h => {
      const d = new Date(h.date); const diffDays = Math.floor((today - d) / oneDay); const v = parseInt(h.volume) || 0;
      if(diffDays < 7) vol7 += v; if(diffDays < 28) vol28 += v; volTotal += v;
    });
    document.getElementById('stat-7days').innerText = (vol7 / 1000).toFixed(1) + " t";
    document.getElementById('stat-28days').innerText = (vol28 / 1000).toFixed(1) + " t";
    document.getElementById('stat-total').innerText = (volTotal / 1000).toFixed(1) + " t";
  }

  function renderChart() {
    const hist = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    const ctx = document.getElementById('growthChartCanvas').getContext('2d');
    const labels = hist.map(h => h.date.substring(5).replace('-','/'));
    let data, label, color, bg;
    if (chartMode === 'volume') { data = hist.map(h => h.volume); label = 'Volume'; color = '#ff453a'; bg = 'rgba(255,69,58,0.2)'; }
    else { data = hist.map(h => h.maxWeight || 0); label = 'Max Weight'; color = '#ffd700'; bg = 'rgba(255, 215, 0, 0.2)'; }
    if(growthChart) { growthChart.data.labels=labels; growthChart.data.datasets[0].data=data; growthChart.data.datasets[0].label=label; growthChart.data.datasets[0].borderColor=color; growthChart.data.datasets[0].backgroundColor=bg; growthChart.update(); }
    else { growthChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: label, data: data, borderColor: color, backgroundColor: bg, borderWidth:2, tension:0.3, fill:true }] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#888',maxTicksLimit:5},grid:{color:'#333'}}, y:{ticks:{color:'#888'},grid:{color:'#333'}}}, plugins:{legend:{display:false}} } }); }
  }
</script>
</body>
</html>
